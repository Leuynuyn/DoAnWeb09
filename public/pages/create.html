<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Th√™m nhi·ªÅu s·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="/stylesheets/styles.css">
  <link rel="stylesheet" href="/stylesheets/header.css">

</head>
<body>
  <div class="header">
    <nav>
      <li><a href="/">Trang Ch·ªß</a></li>
      <li><a href="read.html">T√¨m Ki·∫øm N·ªôi Th·∫•t</a></li>
      <li><a href="create.html">Th√™m N·ªôi Th·∫•t</a></li>
      <li><a href="update.html">C·∫≠p Nh·∫≠t N·ªôi Th·∫•t</a></li>
      <li><a href="delete.html">X√≥a N·ªôi Th·∫•t</a></li>
      <li><a href="list.html">Danh S√°ch N·ªôi Th·∫•t</a></li>
    </nav>
  </div>

  <div style="margin: 30px;">
    <h1>Th√™m nhi·ªÅu s·∫£n ph·∫©m</h1>

    <input type="file" id="jsonFile" accept=".json">
    <button onclick="importFromJson()">üìÇ Nh·∫≠p t·ª´ JSON</button>
    <br><br>

    <table id="productTable" border="1" style="margin-bottom: 20px;">
      <thead>
        <tr>
          <th>ID t·ª± ƒë·ªông</th>
          <th>Danh m·ª•c</th>
          <th>T√™n s·∫£n ph·∫©m</th>
          <th>Ch·∫•t li·ªáu</th>
          <th>M√†u s·∫Øc</th>
          <th>K√≠ch th∆∞·ªõc</th>
          <th>Gi√° g·ªëc</th>
          <th>Gi√° b√°n</th>
          <th>M√¥ t·∫£</th>
          <th>·∫¢nh</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="addRow()">+ Th√™m d√≤ng</button>
    <button onclick="submitAll()">G·ª≠i t·∫•t c·∫£</button>
  </div>

  <script>
    window.onload = () => addRow();

    async function addRow(product = {}) {
      const tbody = document.querySelector("#productTable tbody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>
          <span class="id-display">ƒêang t·∫°o...</span>
          <input type="hidden" name="id">
        </td>
        <td>
          <select name="category">
            <option value="BANN">B√†n</option>
            <option value="TUQA">T·ªß</option>
            <option value="GIUG">Gi∆∞·ªùng</option>
          </select>
        </td>
        <td><input type="text" name="name" placeholder="VD: B√†n g·ªó xoan ƒë√†o"></td>
        <td><input type="text" name="chatlieu" placeholder="VD: G·ªó s·ªìi, Kim lo·∫°i"></td>
        <td><input type="text" name="mausac" placeholder="VD: Tr·∫Øng, X√°m, N√¢u"></td>
        <td><input type="text" name="kichthuoc" placeholder="VD: 120x60, 160x200"></td>
        <td><input type="text" name="giagoc" placeholder="VD: 7,000,000 VND"></td>
        <td><input type="text" name="giaban" placeholder="VD: 6,000,000 VND"></td>
        <td><textarea name="motasanpham" rows="2" placeholder="VD: M√¥ t·∫£ chi ti·∫øt..."></textarea></td>
        <td><input type="file" name="image" accept="image/*"></td>
        <td><button onclick="this.closest('tr').remove()">üóë</button></td>
      `;

      tbody.appendChild(row);

      const select = row.querySelector('[name="category"]');
      select.value = product.category || "BANN";
      row.querySelector('[name="name"]').value = product.name || "";
      row.querySelector('[name="chatlieu"]').value = product.chatlieu || "";
      row.querySelector('[name="mausac"]').value = product.mausac || "";
      row.querySelector('[name="kichthuoc"]').value = product.kichthuoc || "";
      row.querySelector('[name="giagoc"]').value = product.giagoc || "";
      row.querySelector('[name="giaban"]').value = product.giaban || "";
      row.querySelector('[name="motasanpham"]').value = product.motasanpham || "";

      select.addEventListener('change', () => updateGeneratedId(row));
      await updateGeneratedId(row);
    }

    async function updateGeneratedId(row) {
      const category = row.querySelector('[name="category"]').value;
      const idSpan = row.querySelector('.id-display');
      const idInput = row.querySelector('[name="id"]');

      try {
        const res = await fetch(`/generate-id?category=${category}`);
        const data = await res.json();
        idSpan.textContent = data.id;
        idInput.value = data.id;
      } catch (err) {
        idSpan.textContent = 'L·ªói t·∫°o ID';
        idInput.value = '';
      }
    }

    async function submitAll() {
      const rows = document.querySelectorAll("#productTable tbody tr");

      for (const row of rows) {
        // R√ÄNG BU·ªòC: ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß
        const required = ['name', 'chatlieu', 'mausac', 'kichthuoc', 'giagoc', 'giaban', 'motasanpham'];
        let hasEmpty = false;

        for (const name of required) {
          const input = row.querySelector(`[name="${name}"]`);
          if (!input.value.trim()) {
            input.style.border = '2px solid red';
            hasEmpty = true;
          } else {
            input.style.border = '';
          }
        }

        const image = row.querySelector('[name="image"]');
        if (!image.files.length) {
          image.style.border = '2px solid red';
          hasEmpty = true;
        } else {
          image.style.border = '';
        }

        if (hasEmpty) {
          alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ch·ªçn ·∫£nh!");
          return;
        }

        // G·ª≠i l√™n server
        const formData = new FormData();
        formData.append("id", row.querySelector('[name="id"]').value);
        formData.append("category", row.querySelector('[name="category"]').value);
        formData.append("name", row.querySelector('[name="name"]').value);
        formData.append("chatlieu", row.querySelector('[name="chatlieu"]').value.trim());
        formData.append("mausac", row.querySelector('[name="mausac"]').value.trim());
        formData.append("kichthuoc", row.querySelector('[name="kichthuoc"]').value.trim());
        formData.append("giagoc", row.querySelector('[name="giagoc"]').value);
        formData.append("giaban", row.querySelector('[name="giaban"]').value);
        formData.append("motasanpham", row.querySelector('[name="motasanpham"]').value);

        const imageFile = image.files[0];
        formData.append("image", imageFile);

        const response = await fetch("/create", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        console.log("T·∫°o:", result.message);
      }

      alert("‚úÖ ƒê√£ th√™m t·∫•t c·∫£ s·∫£n ph·∫©m!");
      document.querySelector("#productTable tbody").innerHTML = "";
      addRow();
    }

    function importFromJson() {
      const fileInput = document.getElementById("jsonFile");
      const file = fileInput.files[0];
      if (!file) {
        alert("Vui l√≤ng ch·ªçn file JSON.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          for (const product of data) {
            await addRow(product);
          }
        } catch (err) {
          alert("L·ªói ƒë·ªãnh d·∫°ng JSON: " + err.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
